<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calibration Demo</title>

  <style>

    html, body {
      height: 100%;
    }

    #sim-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 80%;
      height: 50%;
    }

    #device-frame {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 100%;
      height: 50%;
    }
  </style>
</head>
<body>

<iframe id="sim-frame"
        src="quadrilateral_en.html?brand=phet&ea&calibrationDemo&screens=1&showVertices&postMessageOnLoad"></iframe>
<iframe id="device-frame"
        src="quadrilateral_en.html?brand=phet&ea&calibrationDemo&screens=2&showVertices&audio=disabled&postMessageOnLoad&showPointerAreas&calibrationDemoDevice"></iframe>

</body>

<script>
  let simulationModel;
  let deviceModel;

  window.addEventListener( 'message', event => {
    if ( !event.data ) {
      return;
    }

    let data;
    try {
      data = JSON.parse( event.data );
    }
    catch( e ) {
      return;
    }

    if ( data.type === 'load' ) {
      if ( data.url.includes( 'screens=1' ) ) {

        // this is the "simulation" screen
        simulationModel = document.getElementById( 'sim-frame' ).contentWindow.simModel;
      }
      else if ( data.url.includes( 'screens=2' ) ) {

        // this is the "device" screen
        deviceModel = document.getElementById( 'device-frame' ).contentWindow.simModel;

        // whenever the device shape changes, send a message to the simulation to recreate the shape
        deviceModel.shapeChangedEmitter.addListener( () => {

          const topLength = deviceModel.topSide.lengthProperty.value;
          const rightLength = deviceModel.rightSide.lengthProperty.value;
          const bottomLength = deviceModel.bottomSide.lengthProperty.value;
          const leftLength = deviceModel.leftSide.lengthProperty.value;

          const p1Angle = deviceModel.vertex1.angleProperty.value;
          const p2Angle = deviceModel.vertex2.angleProperty.value;
          const p3Angle = deviceModel.vertex3.angleProperty.value;
          const p4Angle = deviceModel.vertex4.angleProperty.value;

          // we are in a "calibration" stage, use device data to provide physical model bounds
          if ( simulationModel.isCalibratingProperty.value ) {
            simulationModel.setPhysicalModelBounds( topLength, rightLength, bottomLength, leftLength );
          }
          else if ( simulationModel.physicalModelBounds !== null ) {

            // there must have been a calibration before updating simulation model
            simulationModel.setPositionsFromLengthAndAngleData( topLength, rightLength, bottomLength, leftLength, p1Angle, p2Angle, p3Angle, p4Angle );
          }
        } );

        // we are ready to start calibrating, start populating values
        simulationModel.isCalibratingProperty.link( isCalibrating => {
          const topLength = deviceModel.topSide.lengthProperty.value;
          const rightLength = deviceModel.rightSide.lengthProperty.value;
          const bottomLength = deviceModel.bottomSide.lengthProperty.value;
          const leftLength = deviceModel.leftSide.lengthProperty.value;

          const p1Angle = deviceModel.vertex1.angleProperty.value;
          const p2Angle = deviceModel.vertex2.angleProperty.value;
          const p3Angle = deviceModel.vertex3.angleProperty.value;
          const p4Angle = deviceModel.vertex4.angleProperty.value;

          simulationModel.setPhysicalModelBounds( topLength, rightLength, bottomLength, leftLength );
        } );
      }
    }
  } );
</script>
</html>