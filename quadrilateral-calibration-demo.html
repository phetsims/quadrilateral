<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calibration Demo</title>

  <style>

    html, body {
      height: 100%;
    }

    #sim-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 80%;
      height: 50%;
    }

    #device-frame {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 100%;
      height: 50%;
    }
  </style>
</head>
<body>

<!--<iframe id="sim-frame"-->
<!--        src="./build/phet/quadrilateral_en_phet.html?brand=phet&ea&calibrationDemo&screens=1&showVertices&postMessageOnLoad"></iframe>-->
<!--<iframe id="device-frame"-->
<!--        src="./build/phet/quadrilateral_en_phet.html?brand=phet&ea&calibrationDemo&screens=2&showVertices&audio=disabled&postMessageOnLoad&showPointerAreas&calibrationDemoDevice"></iframe>-->
<iframe id="sim-frame"
        src="quadrilateral_en.html?brand=phet&ea&calibrationDemo&screens=1&showVertices&postMessageOnLoad&deviceConnection"></iframe>
<iframe id="device-frame"
        src="quadrilateral_en.html?brand=phet&ea&calibrationDemo&screens=2&showVertices&audio=disabled&postMessageOnLoad&showPointerAreas&calibrationDemoDevice&deviceConnection"></iframe>

</body>

<script>
  let simulationModel;
  let deviceModel;

  let simulationShapeModel;
  let deviceShapeModel;

  window.addEventListener( 'message', event => {
    if ( !event.data ) {
      return;
    }

    let data;
    try {
      data = JSON.parse( event.data );
    }
    catch( e ) {
      return;
    }

    if ( data.type === 'load' ) {
      if ( data.url.includes( 'screens=1' ) ) {

        // this is the "simulation" screen
        simulationModel = document.getElementById( 'sim-frame' ).contentWindow.simModel;
        simulationShapeModel = simulationModel.quadrilateralShapeModel;
      }
      else if ( data.url.includes( 'screens=2' ) ) {

        // this is the "device" screen
        deviceModel = document.getElementById( 'device-frame' ).contentWindow.simModel;
        deviceShapeModel = deviceModel.quadrilateralShapeModel;

        // whenever the device shape changes, send a message to the simulation to recreate the shape
        deviceShapeModel.shapeChangedEmitter.addListener( () => {

          const topLength = deviceShapeModel.topSide.lengthProperty.value;
          const rightLength = deviceShapeModel.rightSide.lengthProperty.value;
          const bottomLength = deviceShapeModel.bottomSide.lengthProperty.value;
          const leftLength = deviceShapeModel.leftSide.lengthProperty.value;

          const p1Angle = deviceShapeModel.vertexA.angleProperty.value;
          const p2Angle = deviceShapeModel.vertexB.angleProperty.value;
          const p3Angle = deviceShapeModel.vertexC.angleProperty.value;
          const p4Angle = deviceShapeModel.vertexD.angleProperty.value;

          // we are in a "calibration" stage, use device data to provide physical model bounds
          if ( simulationModel.isCalibratingProperty.value ) {
            simulationModel.setPhysicalModelBounds( topLength, rightLength, bottomLength, leftLength );
          }
          else if ( simulationModel.physicalModelBoundsProperty.value !== null ) {

            // there must have been a calibration before updating simulation model
            simulationShapeModel.setPositionsFromLengthAndAngleData( topLength, rightLength, bottomLength, leftLength, p1Angle, p2Angle, p3Angle, p4Angle );
          }
        } );

        // we are ready to start calibrating, start populating values
        simulationModel.isCalibratingProperty.link( isCalibrating => {
          const topLength = deviceShapeModel.topSide.lengthProperty.value;
          const rightLength = deviceShapeModel.rightSide.lengthProperty.value;
          const bottomLength = deviceShapeModel.bottomSide.lengthProperty.value;
          const leftLength = deviceShapeModel.leftSide.lengthProperty.value;

          const p1Angle = deviceShapeModel.vertexA.angleProperty.value;
          const p2Angle = deviceShapeModel.vertexB.angleProperty.value;
          const p3Angle = deviceShapeModel.vertexC.angleProperty.value;
          const p4Angle = deviceShapeModel.vertexD.angleProperty.value;

          simulationModel.setPhysicalModelBounds( topLength, rightLength, bottomLength, leftLength );
        } );
      }
    }
  } );
</script>
</html>